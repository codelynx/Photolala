# Credential Management Plan for Photolala2

## Overview
Clean, organized credential management system using credential-code for secure storage and access.

## Directory Structure

```
Photolala2/
├── .credentials/                 # All credential data (gitignored)
│   ├── README.md                # Instructions for setup
│   ├── config.json              # Master config (which env, which service)
│   │
│   ├── aws/                     # AWS credentials
│   │   ├── dev/
│   │   │   ├── access-key.txt
│   │   │   └── secret-key.txt
│   │   ├── stage/
│   │   │   ├── access-key.txt
│   │   │   └── secret-key.txt
│   │   └── prod/
│   │       ├── access-key.txt
│   │       └── secret-key.txt
│   │
│   ├── apple/                   # Apple Sign-In
│   │   ├── private-key.p8
│   │   └── config.json          # Key ID, Team ID, Client ID
│   │
│   ├── google/                  # Google OAuth
│   │   ├── oauth-config.json    # Client IDs, secrets
│   │   └── service-account.json # If needed for server-side
│   │
│   └── jwt/                     # JWT secrets
│       └── secret.txt
│
├── .credential-tool/            # credential-code tool (gitignored)
│   ├── credential-code          # The actual tool binary/package
│   ├── templates/              # Templates for generation
│   │   ├── swift.template
│   │   └── kotlin.template
│   └── config.json             # Tool configuration
│
├── scripts/                     # Credential management scripts
│   ├── setup-credentials.sh    # Initial setup wizard
│   ├── generate-credentials.sh # Regenerate credential files
│   ├── switch-env.sh           # Switch between dev/stage/prod
│   └── validate-credentials.sh # Check all credentials are present
│
└── apple/Photolala/
    └── Credentials/            # Generated credential access code
        ├── Credentials.swift   # Generated by credential-code
        └── CredentialManager.swift  # Clean API for accessing credentials
```

## Credential Management Workflow

### 1. Initial Setup (One-time)
```bash
# Run interactive setup wizard
./scripts/setup-credentials.sh

# This will:
# - Create .credentials directory structure
# - Prompt for each credential
# - Install credential-code tool
# - Generate initial credential files
```

### 2. Environment Management
```json
// .credentials/config.json
{
  "currentEnvironment": "dev",  // dev | stage | prod
  "environments": {
    "dev": {
      "awsBucket": "photolala-dev",
      "lambdaEndpoint": "https://dev.lambda.url/",
      "debugMode": true
    },
    "stage": {
      "awsBucket": "photolala-stage",
      "lambdaEndpoint": "https://stage.lambda.url/",
      "debugMode": false
    },
    "prod": {
      "awsBucket": "photolala-prod",
      "lambdaEndpoint": "https://prod.lambda.url/",
      "debugMode": false
    }
  }
}
```

### 3. Credential Access Pattern (Swift)

```swift
// CredentialManager.swift - Clean API
public enum CredentialManager {
    public static var currentEnvironment: Environment {
        // Read from config.json
    }

    public static func aws() -> AWSCredentials {
        // Returns credentials for current environment
    }

    public static func google() -> GoogleOAuthConfig {
        // Returns Google OAuth configuration
    }

    public static func apple() -> AppleSignInConfig {
        // Returns Apple Sign-In configuration
    }
}

// Usage in app
let aws = CredentialManager.aws()
let s3Client = S3Client(
    accessKey: aws.accessKeyId,
    secretKey: aws.secretAccessKey,
    region: aws.region
)
```

## Security Features

### 1. Credential Storage
- Plain text files in `.credentials/` (gitignored)
- credential-code encrypts them when building into app
- No credentials in source code

### 2. Environment Switching
```bash
# Easy environment switching
./scripts/switch-env.sh dev
./scripts/switch-env.sh prod

# Automatically regenerates Credentials.swift
```

### 3. Validation
```bash
# Check all required credentials exist
./scripts/validate-credentials.sh

# Output:
# ✅ AWS Dev credentials
# ✅ AWS Stage credentials
# ❌ AWS Prod credentials (missing secret-key.txt)
# ✅ Apple Sign-In
# ✅ Google OAuth
```

## Benefits of This Approach

1. **Single Source of Truth**: All credentials in `.credentials/`
2. **Environment Management**: Easy switching between dev/stage/prod
3. **Type Safety**: Generated Swift code with proper types
4. **Security**: Credentials encrypted in binary, not in source
5. **Developer Experience**: Simple scripts, clear structure
6. **Validation**: Can verify setup is complete
7. **Documentation**: Self-documenting structure

## Migration from Photolala1

1. Extract credentials from various locations in Photolala1
2. Organize into new structure
3. Use credential-code to generate secure access code
4. Update app code to use CredentialManager API

## Next Steps

1. Set up `.credentials/` directory structure
2. Create setup and management scripts
3. Install/configure credential-code tool
4. Generate Swift credential access layer
5. Update app to use new credential system
6. Document the process